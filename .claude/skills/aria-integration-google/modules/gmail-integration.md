# Gmail Integration Module

## Overview

Gmail API integration for regulatory email management in ARIA Phase 4.

## MCP Tool Interfaces

### 1. Search Emails

```typescript
interface GmailSearchParams {
  query: string;
  maxResults?: number;
  labelIds?: string[];
}

interface GmailMessage {
  id: string;
  threadId: string;
  snippet: string;
  internalDate: string;
  payload: {
    headers: { name: string; value: string }[];
    body?: { data: string };
  };
}
```

**Tool**: `mcp__google-workspace__gmail_search`

**Usage**:
```typescript
const results = await mcp__google-workspace__gmail_search({
  query: 'subject:"regulatory" from:fda.gov',
  maxResults: 10,
  labelIds: ['INBOX', 'REGULATORY']
});
```

### 2. Send Email

```typescript
interface GmailSendParams {
  to: string[];
  subject: string;
  body: string;
  cc?: string[];
  bcc?: string[];
  attachments?: Array<{
    filename: string;
    content: string; // base64 encoded
    mimeType: string;
  }>;
}
```

**Tool**: `mcp__google-workspace__gmail_send`

**Usage**:
```typescript
await mcp__google-workspace__gmail_send({
  to: ['regulator@example.com'],
  subject: '[ARIA] 510(k) Submission Complete: SUB-001',
  body: 'Submission details...',
  attachments: [{
    filename: 'submission.pdf',
    content: base64Content,
    mimeType: 'application/pdf'
  }]
});
```

## Regulatory Email Use Cases

### 1. Submission Notifications

**Template**: Submission Complete Notice

```typescript
interface SubmissionEmailParams {
  submissionId: string;
  submissionType: '510(k)' | 'PMA' | 'CE' | 'MFDS';
  targetMarket: string;
  submissionDate: Date;
  documentLinks: string[];
}

function generateSubmissionEmail(params: SubmissionEmailParams): GmailSendParams {
  const subject = `[ARIA] ${params.submissionType} Submission Complete: ${params.submissionId}`;
  const body = `
Submission Details:
- ID: ${params.submissionId}
- Type: ${params.submissionType}
- Market: ${params.targetMarket}
- Date: ${params.submissionDate.toISOString()}

Documents:
${params.documentLinks.map(link => `- ${link}`).join('\n')}

This email was automatically generated by ARIA Regulatory Manager.
  `.trim();

  return {
    to: ['regulatory-team@company.com'],
    subject,
    body,
  };
}
```

### 2. CAPA Notifications

**Template**: CAPA Assignment Notice

```typescript
interface CAPAEmailParams {
  capaId: string;
  source: 'Internal Audit' | 'Customer Complaint' | 'Nonconformance';
  problemStatement: string;
  dueDate: Date;
  assignee: string;
}

function generateCAPAEmail(params: CAPAEmailParams): GmailSendParams {
  const subject = `[ARIA] CAPA Assigned: ${params.capaId}`;
  const body = `
CAPA Details:
- ID: ${params.capaId}
- Source: ${params.source}
- Problem: ${params.problemStatement}
- Due Date: ${params.dueDate.toISOString()}

Please access the full CAPA details in the ARIA system.
  `.trim();

  return {
    to: [params.assignee],
    subject,
    body,
  };
}
```

### 3. Regulatory Correspondence Tracking

**Query Patterns**:

```typescript
// FDA correspondence
const fdaEmails = await mcp__google-workspace__gmail_search({
  query: 'from:(fda.gov OR fda.net) subject:"regulatory"',
  maxResults: 50
});

// Notified Body communications
const nbEmails = await mcp__google-workspace__gmail_search({
  query: 'from:*.notifiedbody.eu subject:"MDR"',
  maxResults: 50
});

// MFDS submissions
const mfdsEmails = await mcp__google-workspace__gmail_search({
  query: 'from:mfds.go.kr subject:"medical device"',
  maxResults: 50
});
```

## Label Management

### Regulatory Label Structure

```typescript
interface RegulatoryLabels {
  primary: 'REGULATORY';
  secondary: [
    'FDA',
    'EU-MDR',
    'MFDS',
    'SUBMISSION',
    'CAPA',
    'AUDIT',
    'COMPLIANCE'
  ];
}
```

### Auto-Labeling Rules

```typescript
interface LabelRule {
  pattern: string;
  label: string;
  color?: string;
}

const regulatoryLabelRules: LabelRule[] = [
  { pattern: 'from:fda.gov', label: 'FDA', color: '#1967d2' },
  { pattern: 'subject:"510(k)"', label: 'SUBMISSION', color: '#188038' },
  { pattern: 'subject:"CAPA"', label: 'CAPA', color: '#c5221f' },
  { pattern: 'from:*.notifiedbody.eu', label: 'EU-MDR', color: '#1a73e8' },
  { pattern: 'from:mfds.go.kr', label: 'MFDS', color: '#0b804b' },
];
```

## Email Templates

### Template Storage Structure

```typescript
interface EmailTemplate {
  id: string;
  name: string;
  subject: string;
  bodyTemplate: string;
  variables: string[];
  language: 'en' | 'ko';
}

const emailTemplates: EmailTemplate[] = [
  {
    id: 'submission-complete-en',
    name: 'Submission Complete Notice (English)',
    subject: '[ARIA] Submission Complete: {submissionId}',
    bodyTemplate: `
Dear Regulatory Team,

This email confirms that submission {submissionId} has been completed.

Submission Details:
- Type: {submissionType}
- Target Market: {targetMarket}
- Submission Date: {submissionDate}
- Documents: {documentCount} files

View full details: {portalUrl}

ARIA Regulatory Manager
    `.trim(),
    variables: ['submissionId', 'submissionType', 'targetMarket', 'submissionDate', 'documentCount', 'portalUrl'],
    language: 'en'
  },
  {
    id: 'submission-complete-ko',
    name: '제출 완료 알림 (한국어)',
    subject: '[ARIA] 제출 완료: {submissionId}',
    bodyTemplate: `
규제팀 귀하,

제출 {submissionId}이(가) 완료되었음을 알려드립니다.

제출 세부정보:
- 유형: {submissionType}
- 대상 시장: {targetMarket}
- 제출일: {submissionDate}
- 문서: {documentCount}개 파일

상세 정보 보기: {portalUrl}

ARIA 규제 관리자
    `.trim(),
    variables: ['submissionId', 'submissionType', 'targetMarket', 'submissionDate', 'documentCount', 'portalUrl'],
    language: 'ko'
  }
];
```

## Error Handling

| Error | Description | Resolution |
|-------|-------------|------------|
| `invalid_recipient` | Invalid email address | Verify recipient email |
| `rate_limit_exceeded` | API rate limit exceeded | Implement exponential backoff |
| `message_too_large` | Email > 25MB | Reduce attachment sizes |
| `unauthorized` | Invalid access token | Refresh OAuth token |

## Testing

### Test Cases

1. **Search Query Validation**: Verify search query syntax
2. **Email Send**: Mock Gmail send endpoint
3. **Template Rendering**: Test variable substitution
4. **Label Application**: Verify label rules
5. **Error Scenarios**: Test all error cases
