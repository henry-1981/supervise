# Google Docs Integration Module

## Overview

Google Docs API integration for regulatory document creation in ARIA Phase 4.

## MCP Tool Interfaces

### 1. Create Document

```typescript
interface DocsCreateParams {
  title: string;
  content?: string;
}

interface DocsResponse {
  documentId: string;
  title: string;
}
```

**Tool**: `mcp__google-workspace__docs_create`

### 2. Append Content

```typescript
interface DocsAppendParams {
  documentId: string;
  content: string;
  insertIndex?: number;
}
```

**Tool**: `mcp__google-workspace__docs_append`

## Regulatory Document Templates

### 1. Regulatory Requirement Document

**Template ID**: `regulatory-requirement`

```typescript
interface RegulatoryRequirementDoc {
  requirementId: string;
  category: 'FDA' | 'ISO 13485' | 'EU MDR' | 'MFDS';
  description: string;
  complianceMethod: string;
  evidence: string[];
  status: 'Draft' | 'Review' | 'Approved';
  version: string;
  effectiveDate: Date;
}

function generateRequirementDoc(doc: RegulatoryRequirementDoc): string {
  return `
# Regulatory Requirement: ${doc.requirementId}

**Category**: ${doc.category}
**Version**: ${doc.version}
**Status**: ${doc.status}
**Effective Date**: ${doc.effectiveDate.toISOString()}

## Requirement Description

${doc.description}

## Compliance Method

${doc.complianceMethod}

## Evidence

${doc.evidence.map(e => `- ${e}`).join('\n')}

## Approval History

| Date | Action | Approver | Comments |
|------|--------|----------|----------|
| ${new Date().toISOString()} | Created | ARIA System | Initial version |

---
*This document was automatically generated by ARIA Regulatory Manager*
  `.trim();
}
```

### 2. CAPA Report

**Template ID**: `capa-report`

```typescript
interface CAPADocument {
  capaId: string;
  source: string;
  problemStatement: string;
  rootCause: string;
  correctionAction: string;
  preventionAction: string;
  effectivenessCheck: string;
  dueDate: Date;
  status: 'Open' | 'In Progress' | 'Closed';
}

function generateCAPADoc(doc: CAPADocument): string {
  return `
# CAPA Report: ${doc.capaId}

**Source**: ${doc.source}
**Status**: ${doc.status}
**Due Date**: ${doc.dueDate.toISOString()}

## 1. Problem Statement

${doc.problemStatement}

## 2. Root Cause Analysis

${doc.rootCause}

### Analysis Method
- [ ] 5 Whys
- [ ] Fishbone Diagram
- [ ] FMEA
- [ ] Other: ____________

### Root Cause(s)
${doc.rootCause}

## 3. Corrective Action

${doc.correctionAction}

### Implementation Plan
| Action | Owner | Target Date | Status |
|--------|-------|-------------|--------|
| Action 1 | | | |
| Action 2 | | | |

## 4. Preventive Action

${doc.preventionAction}

### Implementation Plan
| Action | Owner | Target Date | Status |
|--------|-------|-------------|--------|
| Action 1 | | | |
| Action 2 | | | |

## 5. Effectiveness Check

${doc.effectivenessCheck}

### Verification Method
- [ ] Document Review
- [ ] Process Audit
- [ ] Data Analysis
- [ ] Other: ____________

### Results
| Check Date | Result | Findings | Verified By |
|-------------|--------|----------|-------------|
| | | | |

## 6. Closure

| Field | Value |
|-------|-------|
| CAPA Closed Date | |
| Closed By | |
| Final Effectiveness | [ ] Effective [ ] Not Effective |
| Next Review Date | |

---
*CAPA Report generated by ARIA Regulatory Manager*
  `.trim();
}
```

### 3. Risk Assessment Document

**Template ID**: `risk-assessment`

```typescript
interface RiskAssessmentDoc {
  riskId: string;
  hazard: string;
  harm: string;
  causes: string[];
  initialSeverity: 'High' | 'Medium' | 'Low';
  initialProbability: 'High' | 'Medium' | 'Low';
  initialRPN: number;
  mitigationStrategy: string;
  residualSeverity: 'High' | 'Medium' | 'Low';
  residualProbability: 'High' | 'Medium' | 'Low';
  residualRPN: number;
  acceptability: 'Acceptable' | 'Not Acceptable';
}

function generateRiskAssessmentDoc(doc: RiskAssessmentDoc): string {
  const severityMap = { High: 3, Medium: 2, Low: 1 };
  const initialScore = severityMap[doc.initialSeverity] * severityMap[doc.initialProbability];
  const residualScore = severityMap[doc.residualSeverity] * severityMap[doc.residualProbability];

  return `
# Risk Assessment: ${doc.riskId}

**Risk ID**: ${doc.riskId}
**Assessment Date**: ${new Date().toISOString()}
**Reviewer**: ARIA System

## 1. Risk Identification

### Hazard
${doc.hazard}

### Harm
${doc.harm}

### Causes
${doc.causes.map(c => `- ${c}`).join('\n')}

## 2. Initial Risk Assessment

| Parameter | Score | Justification |
|-----------|-------|---------------|
| Severity | ${doc.initialSeverity} (3=${severityMap[doc.initialSeverity]}) | |
| Probability | ${doc.initialProbability} (3=${severityMap[doc.initialProbability]}) | |
| **Initial RPN** | **${initialScore}** | |

### Risk Matrix Evaluation
- [ ] High Risk (RPN ≥ 6)
- [ ] Medium Risk (RPN 3-5)
- [ ] Low Risk (RPN 1-2)

**Initial Risk Level**: ${initialScore >= 6 ? 'HIGH' : initialScore >= 3 ? 'MEDIUM' : 'LOW'}

## 3. Risk Control Measures

### Mitigation Strategy
${doc.mitigationStrategy}

### Implementation Plan
| Control Measure | Owner | Target Date | Status |
|-----------------|-------|-------------|--------|
| | | | |

## 4. Residual Risk Assessment

| Parameter | Score | Justification |
|-----------|-------|---------------|
| Severity | ${doc.residualSeverity} (3=${severityMap[doc.residualSeverity]}) | |
| Probability | ${doc.residualProbability} (3=${severityMap[doc.residualProbability]}) | |
| **Residual RPN** | **${residualScore}** | |

### Risk Matrix Evaluation
- [ ] High Risk (RPN ≥ 6)
- [ ] Medium Risk (RPN 3-5)
- [ ] Low Risk (RPN 1-2)

**Residual Risk Level**: ${residualScore >= 6 ? 'HIGH' : residualScore >= 3 ? 'MEDIUM' : 'LOW'}

## 5. Risk Acceptability

**Overall Risk Acceptability**: ${doc.acceptability}

### Acceptance Justification
${doc.acceptability === 'Acceptable'
  ? 'Residual risk is ALARP (As Low As Reasonably Practicable).'
  : 'Additional risk control measures required.'}

### Review Requirements
- [ ] Annual review required
- [ ] Review upon change
- [ ] Review after incident
- [ ] Next review date: ____________

## 6. Approval

| Role | Name | Signature | Date |
|------|------|-----------|------|
| Risk Manager | | | |
| Quality Manager | | | |
| Approved By | | | |

---
*Risk Assessment generated by ARIA Regulatory Manager per ISO 14971:2019*
  `.trim();
}
```

### 4. Audit Report

**Template ID**: `audit-report`

```typescript
interface AuditReportDoc {
  auditId: string;
  auditType: 'Internal' | 'External' | 'Supplier';
  auditDate: Date;
  auditor: string;
  auditee: string;
  scope: string;
  findings: Array<{
    category: string;
    description: string;
    severity: 'Major' | 'Minor' | 'Observation';
    reference: string;
  }>;
  conclusion: string;
}

function generateAuditReportDoc(doc: AuditReportDoc): string {
  return `
# Audit Report: ${doc.auditId}

**Audit Type**: ${doc.auditType}
**Audit Date**: ${doc.auditDate.toISOString()}
**Auditor**: ${doc.auditor}
**Auditee**: ${doc.auditee}

## Executive Summary

${doc.conclusion}

## 1. Audit Scope

${doc.scope}

## 2. Audit Findings

### Summary
| Severity | Count |
|----------|-------|
| Major Nonconformance | ${doc.findings.filter(f => f.severity === 'Major').length} |
| Minor Nonconformance | ${doc.findings.filter(f => f.severity === 'Minor').length} |
| Observation | ${doc.findings.filter(f => f.severity === 'Observation').length} |

### Detailed Findings

${doc.findings.map((finding, idx) => `
#### Finding ${idx + 1}: ${finding.category}

**Severity**: ${finding.severity}
**Reference**: ${finding.reference}

**Description**
${finding.description}

**Proposed Correction**
[ ] Immediate action required
[ ] Root cause analysis required
[ ] CAPA initiated: ____________

**Verification**
| Action | Owner | Target Date | Completion Date |
|--------|-------|-------------|-----------------|
| | | | |
`).join('\n')}

## 3. Compliance Assessment

### ISO 13485:2016 Clauses Assessed

| Clause | Compliant | Nonconformities | Notes |
|--------|-----------|-----------------|-------|
| 4. Quality Management System | [ ] | | |
| 5. Management Responsibility | [ ] | | |
| 6. Resource Management | [ ] | | |
| 7. Product Realization | [ ] | | |
| 8. Measurement, Analysis, Improvement | [ ] | | |

## 4. Conclusion

**Overall Audit Result**: ${doc.findings.some(f => f.severity === 'Major') ? 'FAIL' : 'PASS'}

### Required Actions
${doc.findings.filter(f => f.severity === 'Major').length > 0
  ? `- ${doc.findings.filter(f => f.severity === 'Major').length} major nonconformities require immediate correction`
  : '- No major nonconformities found'}
- ${doc.findings.filter(f => f.severity === 'Minor').length} minor nonconformities to be addressed
- ${doc.findings.filter(f => f.severity === 'Observation').length} observations for improvement

### Follow-up Required
- [ ] Yes - Follow-up audit scheduled for: ____________
- [ ] No - Findings resolved during audit

## 5. Approval

| Role | Name | Signature | Date |
|------|------|-----------|------|
| Auditor | | | |
| Auditee | | | |
| Quality Manager | | | |

---
*Audit Report generated by ARIA Regulatory Manager*
  `.trim();
}
```

## Document Creation Workflow

### Step-by-Step Process

```typescript
async function createRegulatoryDocument(
  templateId: string,
  data: unknown
): Promise<string> {
  // 1. Select template
  const template = emailTemplates.find(t => t.id === templateId);
  if (!template) {
    throw new Error(`Template ${templateId} not found`);
  }

  // 2. Generate content
  let content: string;
  switch (templateId) {
    case 'regulatory-requirement':
      content = generateRequirementDoc(data as RegulatoryRequirementDoc);
      break;
    case 'capa-report':
      content = generateCAPADoc(data as CAPADocument);
      break;
    case 'risk-assessment':
      content = generateRiskAssessmentDoc(data as RiskAssessmentDoc);
      break;
    case 'audit-report':
      content = generateAuditReportDoc(data as AuditReportDoc);
      break;
    default:
      throw new Error(`Unknown template: ${templateId}`);
  }

  // 3. Create document
  const doc = await mcp__google-workspace__docs_create({
    title: `${templateId}-${Date.now()}`,
    content,
  });

  // 4. Return document ID
  return doc.documentId;
}
```

## Error Handling

| Error | Description | Resolution |
|-------|-------------|------------|
| `invalid_template` | Template not found | Verify template ID |
| `missing_required_field` | Required data missing | Check input data |
| `document_too_large` | Document exceeds size limit | Split into sections |
| `unauthorized` | Invalid access token | Refresh OAuth token |

## Testing

### Test Cases

1. **Document Creation**: Verify each template
2. **Content Generation**: Test data substitution
3. **Format Validation**: Check markdown formatting
4. **Error Scenarios**: Test all error cases
5. **Integration Tests**: Test full workflow
