{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ARIA Workflow State Machine Schema",
  "description": "State machine schema for ARIA workflows (Clinical Evaluation, Internal Audit, Post-Market Surveillance)",
  "type": "object",
  "definitions": {
    "workflow_state": {
      "type": "object",
      "properties": {
        "workflow_id": {
          "type": "string",
          "pattern": "^WF-[A-Z]+-\\d{4}-\\d{3}$",
          "description": "Unique workflow identifier (e.g., WF-CE-2025-001)"
        },
        "workflow_type": {
          "type": "string",
          "enum": ["clinical_evaluation", "internal_audit", "post_market_surveillance"],
          "description": "Type of workflow"
        },
        "current_stage": {
          "type": "string",
          "description": "Current stage name"
        },
        "status": {
          "type": "string",
          "enum": ["not_started", "in_progress", "completed", "on_hold", "cancelled"],
          "description": "Overall workflow status"
        },
        "progress": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Progress percentage (0-100)"
        },
        "context": {
          "$ref": "#/definitions/workflow_context"
        },
        "history": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/history_entry"
          }
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "Workflow creation timestamp"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "Last update timestamp"
        }
      },
      "required": ["workflow_id", "workflow_type", "current_stage", "status", "progress", "context", "created_at"]
    },

    "workflow_context": {
      "type": "object",
      "properties": {
        "device_identification": {
          "type": "object",
          "properties": {
            "name": {"type": "string"},
            "model": {"type": "string"},
            "manufacturer": {"type": "string"}
          }
        },
        "regulatory_requirements": {
          "type": "array",
          "items": {"type": "string"}
        },
        "collected_data": {
          "type": "object",
          "additionalProperties": true
        },
        "generated_documents": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "document_type": {"type": "string"},
              "file_path": {"type": "string"},
              "generated_at": {"type": "string", "format": "date-time"}
            }
          }
        },
        "decisions_made": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "decision": {"type": "string"},
              "rationale": {"type": "string"},
              "made_at": {"type": "string", "format": "date-time"}
            }
          }
        },
        "flags": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "flag_type": {"type": "string"},
              "severity": {"type": "string", "enum": ["critical", "major", "minor"]},
              "description": {"type": "string"},
              "created_at": {"type": "string", "format": "date-time"},
              "resolved": {"type": "boolean"}
            }
          }
        }
      }
    },

    "history_entry": {
      "type": "object",
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "event": {
          "type": "string"
        },
        "from_stage": {
          "type": "string"
        },
        "to_stage": {
          "type": "string"
        },
        "actor": {
          "type": "string"
        },
        "notes": {
          "type": "string"
        }
      },
      "required": ["timestamp", "event"]
    },

    "clinical_evaluation_workflow": {
      "allOf": [
        {"$ref": "#/definitions/workflow_state"},
        {
          "type": "object",
          "properties": {
            "workflow_type": {
              "const": "clinical_evaluation"
            },
            "stages": {
              "type": "object",
              "properties": {
                "scope_definition": {
                  "$ref": "#/definitions/stage_state"
                },
                "literature_search": {
                  "$ref": "#/definitions/stage_state"
                },
                "data_analysis": {
                  "$ref": "#/definitions/stage_state"
                },
                "cer_generation": {
                  "$ref": "#/definitions/stage_state"
                }
              }
            }
          }
        }
      ]
    },

    "internal_audit_workflow": {
      "allOf": [
        {"$ref": "#/definitions/workflow_state"},
        {
          "type": "object",
          "properties": {
            "workflow_type": {
              "const": "internal_audit"
            },
            "stages": {
              "type": "object",
              "properties": {
                "audit_planning": {
                  "$ref": "#/definitions/stage_state"
                },
                "audit_execution": {
                  "$ref": "#/definitions/stage_state"
                },
                "capa_planning": {
                  "$ref": "#/definitions/stage_state"
                },
                "verification": {
                  "$ref": "#/definitions/stage_state"
                }
              }
            }
          }
        }
      ]
    },

    "post_market_surveillance_workflow": {
      "allOf": [
        {"$ref": "#/definitions/workflow_state"},
        {
          "type": "object",
          "properties": {
            "workflow_type": {
              "const": "post_market_surveillance"
            },
            "stages": {
              "type": "object",
              "properties": {
                "data_collection": {
                  "$ref": "#/definitions/stage_state"
                },
                "trend_analysis": {
                  "$ref": "#/definitions/stage_state"
                },
                "reporting": {
                  "$ref": "#/definitions/stage_state"
                },
                "fsca_trigger": {
                  "$ref": "#/definitions/conditional_stage"
                }
              }
            }
          }
        }
      ]
    },

    "stage_state": {
      "type": "object",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "skipped"]
        },
        "progress": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "outputs": {
          "type": "object",
          "additionalProperties": true
        },
        "steps": {
          "type": "object",
          "additionalProperties": {
            "type": "string",
            "enum": ["pending", "in_progress", "completed"]
          }
        }
      },
      "required": ["status"]
    },

    "conditional_stage": {
      "allOf": [
        {"$ref": "#/definitions/stage_state"},
        {
          "type": "object",
          "properties": {
            "condition_met": {
              "type": "boolean"
            },
            "condition_trigger": {
              "type": "string"
            }
          }
        }
      ]
    }
  }
}
